<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SwiftGenerator.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">swift-generator</a> &gt; <a href="index.html" class="el_package">com.facebook.swift.generator</a> &gt; <span class="el_source">SwiftGenerator.java</span></div><h1>SwiftGenerator.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2012 Facebook, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may
 * not use this file except in compliance with the License. You may obtain
 * a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations
 * under the License.
 */
package com.facebook.swift.generator;

import com.facebook.swift.generator.util.TemplateLoader;
import com.facebook.swift.generator.visitors.ExceptionVisitor;
import com.facebook.swift.generator.visitors.IntegerEnumVisitor;
import com.facebook.swift.generator.visitors.ServiceVisitor;
import com.facebook.swift.generator.visitors.StringEnumVisitor;
import com.facebook.swift.generator.visitors.StructVisitor;
import com.facebook.swift.generator.visitors.TypeVisitor;
import com.facebook.swift.parser.model.Document;
import com.facebook.swift.parser.model.Header;
import com.facebook.swift.parser.visitor.DocumentVisitor;
import com.google.common.base.Objects;
import com.google.common.base.Preconditions;
import com.google.common.base.Splitter;
import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Iterables;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.IOException;
import java.net.URI;
import java.util.List;
import java.util.Map;

import javax.annotation.Nullable;

import static com.facebook.swift.generator.util.SwiftInternalStringUtils.isBlank;

/**
 * Parses a Thrift IDL file and writes out initial annotated java classes.
 */
public class SwiftGenerator
{
<span class="nc" id="L53">    private static final Logger LOG = LoggerFactory.getLogger(SwiftGenerator.class);</span>

<span class="nc" id="L55">    private static final Map&lt;String, String&gt; TEMPLATES = ImmutableMap.of(&quot;java-regular&quot;, &quot;java/regular.st&quot;,</span>
                                                                         &quot;java-immutable&quot;, &quot;java/immutable.st&quot;);

    private final File outputFolder;
    private final SwiftGeneratorConfig swiftGeneratorConfig;

    private final TemplateLoader templateLoader;

    public SwiftGenerator(final SwiftGeneratorConfig swiftGeneratorConfig)
<span class="nc" id="L64">    {</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        Preconditions.checkState(TEMPLATES.get(swiftGeneratorConfig.getCodeFlavor()) != null, &quot;Templating type %s is unknown!&quot;, swiftGeneratorConfig.getCodeFlavor());</span>

<span class="nc" id="L67">        this.swiftGeneratorConfig = swiftGeneratorConfig;</span>

<span class="nc" id="L69">        this.outputFolder = swiftGeneratorConfig.getOutputFolder();</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (outputFolder != null) {</span>
<span class="nc" id="L71">            outputFolder.mkdirs();</span>
        }

<span class="nc" id="L74">        LOG.debug(&quot;Writing source files into {} using {} ...&quot;, outputFolder, swiftGeneratorConfig.getCodeFlavor());</span>

<span class="nc" id="L76">        this.templateLoader = new TemplateLoader(TEMPLATES.get(swiftGeneratorConfig.getCodeFlavor()));</span>
<span class="nc" id="L77">    }</span>

    public void parse() throws Exception
    {
<span class="nc" id="L81">        LOG.info(&quot;Parsing Thrift IDL from {}...&quot;, swiftGeneratorConfig.getInputs());</span>

<span class="nc" id="L83">        final Map&lt;String, SwiftDocumentContext&gt; contexts = Maps.newHashMap();</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        for (final URI inputUri : swiftGeneratorConfig.getInputs()) {</span>

<span class="nc bnc" id="L86" title="All 2 branches missed.">            parseDocument(inputUri.isAbsolute() ? inputUri</span>
                                                : swiftGeneratorConfig.getInputBase().resolve(inputUri),
                          contexts,
                          new TypeRegistry(),
                          new TypedefRegistry());
<span class="nc" id="L91">        }</span>

<span class="nc" id="L93">        LOG.info(&quot;IDL parsing complete, writing java code...&quot;);</span>

<span class="nc bnc" id="L95" title="All 2 branches missed.">        for (final SwiftDocumentContext context : contexts.values()) {</span>
<span class="nc" id="L96">            generateFiles(context);</span>
<span class="nc" id="L97">        }</span>

<span class="nc" id="L99">        LOG.info(&quot;Java code generation complete.&quot;);</span>
<span class="nc" id="L100">    }</span>

    private void parseDocument(final URI thriftUri,
                               @Nullable final Map&lt;String, SwiftDocumentContext&gt; contexts,
                               final TypeRegistry typeRegistry,
                               final TypedefRegistry typedefRegistry) throws IOException
    {
<span class="nc bnc" id="L107" title="All 6 branches missed.">        Preconditions.checkState(thriftUri != null &amp;&amp; thriftUri.isAbsolute() &amp;&amp; !thriftUri.isOpaque(), &quot;Only absolute, non opaque URIs can be parsed!&quot;);</span>
<span class="nc" id="L108">        LOG.debug(&quot;Parsing {}...&quot;, thriftUri);</span>

<span class="nc" id="L110">        final String thriftNamespace = extractThriftNamespace(thriftUri);</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">        Preconditions.checkState(!isBlank(thriftNamespace), &quot;Thrift URI %s can not be translated to a namespace&quot;, thriftUri);</span>
<span class="nc" id="L113">        final SwiftDocumentContext context = new SwiftDocumentContext(thriftUri, thriftNamespace, swiftGeneratorConfig, typeRegistry, typedefRegistry);</span>

<span class="nc" id="L115">        final Document document = context.getDocument();</span>
<span class="nc" id="L116">        final Header header = document.getHeader();</span>
<span class="nc" id="L117">        final String javaNamespace = Objects.firstNonNull(Objects.firstNonNull(swiftGeneratorConfig.getOverridePackage(),</span>
                                                                               header.getNamespace(&quot;java&quot;)),
                                                          swiftGeneratorConfig.getDefaultPackage());
<span class="nc bnc" id="L120" title="All 2 branches missed.">        Preconditions.checkState(!isBlank(javaNamespace), &quot;thrift uri %s does not declare a java namespace!&quot;, thriftUri);</span>

<span class="nc bnc" id="L122" title="All 2 branches missed.">        for (final String include : header.getIncludes()) {</span>
<span class="nc" id="L123">            final URI includeUri = swiftGeneratorConfig.getInputBase().resolve(include);</span>
<span class="nc" id="L124">            LOG.debug(&quot;Found {} included from {}.&quot;, includeUri, thriftUri);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            parseDocument(includeUri,</span>
                          // If the includes should also generate code, pass the list of
                          // contexts down to the include parser, otherwise pass a null in
                          swiftGeneratorConfig.isGenerateIncludedCode() ? contexts : null,
                          typeRegistry,
                          typedefRegistry);
<span class="nc" id="L131">        }</span>

<span class="nc" id="L133">        document.visit(new TypeVisitor(javaNamespace, context));</span>

<span class="nc bnc" id="L135" title="All 4 branches missed.">        if (contexts != null &amp;&amp; contexts.put(context.getNamespace(), context) != null) {</span>
<span class="nc" id="L136">            LOG.info(&quot;Thrift Namespace {} included multiple times!&quot;, context.getNamespace());</span>
        }
<span class="nc" id="L138">    }</span>

    private String extractThriftNamespace(final URI thriftUri)
    {
<span class="nc" id="L142">        final String path = thriftUri.getPath();</span>
<span class="nc" id="L143">        final String filename = Iterables.getLast(Splitter.on('/').split(path), null);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        Preconditions.checkState(filename != null, &quot;No thrift namespace found in %s&quot;, thriftUri);</span>

<span class="nc" id="L146">        final String name = Iterables.getFirst(Splitter.on('.').split(filename), null);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        Preconditions.checkState(name != null, &quot;No thrift namespace found in %s&quot;, thriftUri);</span>
<span class="nc" id="L148">        return name;</span>
    }

    private void generateFiles(final SwiftDocumentContext context) throws IOException
    {
<span class="nc" id="L153">        LOG.debug(&quot;Generating code for {}...&quot;, context.getNamespace());</span>

<span class="nc bnc" id="L155" title="All 2 branches missed.">        Preconditions.checkState(outputFolder != null, &quot;The output folder was not set!&quot;);</span>
<span class="nc bnc" id="L156" title="All 6 branches missed.">        Preconditions.checkState(outputFolder.isDirectory() &amp;&amp; outputFolder.canWrite() &amp;&amp; outputFolder.canExecute(), &quot;output folder '%s' is not valid!&quot;, outputFolder.getAbsolutePath());</span>

<span class="nc" id="L158">        final List&lt;DocumentVisitor&gt; visitors = Lists.newArrayList();</span>
<span class="nc" id="L159">        visitors.add(new ServiceVisitor(templateLoader, context, swiftGeneratorConfig, outputFolder));</span>
<span class="nc" id="L160">        visitors.add(new StructVisitor(templateLoader, context, swiftGeneratorConfig, outputFolder));</span>
<span class="nc" id="L161">        visitors.add(new ExceptionVisitor(templateLoader, context, swiftGeneratorConfig, outputFolder));</span>
<span class="nc" id="L162">        visitors.add(new IntegerEnumVisitor(templateLoader, context, swiftGeneratorConfig, outputFolder));</span>
<span class="nc" id="L163">        visitors.add(new StringEnumVisitor(templateLoader, context, swiftGeneratorConfig, outputFolder));</span>

<span class="nc bnc" id="L165" title="All 2 branches missed.">        for (DocumentVisitor visitor : visitors) {</span>
<span class="nc" id="L166">            context.getDocument().visit(visitor);</span>
<span class="nc" id="L167">        }</span>
<span class="nc" id="L168">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.1.201212231917</span></div></body></html>